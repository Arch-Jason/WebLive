<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>在线直播</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        background: #f5f6fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .main-container {
        display: flex;
        flex: 1;
        gap: 1rem;
        padding: 1rem;
        flex-wrap: wrap; /* 手机端自动堆叠 */
        box-sizing: border-box;
        height: 80vh;
      }

      .video-wrapper {
        flex: 3 1 600px; /* 占大部分，最小宽度 600px */
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      video {
        width: 100%;
        border-radius: 10px;
        background: #000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .chat-wrapper {
        flex: 1 1 300px; /* 占小部分，最小宽度 300px */
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-height: 100%;
      }

      #chat-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      #chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        font-size: 14px;
        background: #fafafa;
      }

      #chat-input-area {
        display: flex;
        padding: 8px;
        border-top: 1px solid #eee;
      }

      #chat-input {
        flex: 1;
        margin-right: 8px;
      }

      .room-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      @media (orientation: portrait) {
        .main-container {
          flex-direction: row;
          padding: 0.5rem;
        }
        .video-wrapper, .chat-wrapper {
          flex: 1 1 100%;
        }
        #chat-container {
          height: 50vh;
          max-height: 50vh;
        }
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <!-- 视频部分 -->
      <div class="video-wrapper">
        <div class="room-control">
          <input
            type="text"
            id="roomId"
            value="stream"
            class="form-control form-control-sm"
            style="max-width: 150px"
          />
          <button id="playBtn" class="btn btn-success btn-sm">▶ 播放</button>
        </div>
        <video id="videoElement" controls autoplay></video>
      </div>

      <!-- 聊天部分 -->
      <div class="chat-wrapper">
        <div id="chat-container">
          <div class="p-2 border-bottom bg-light">
            <div class="input-group input-group-sm">
              <span class="input-group-text">昵称</span>
              <input
                type="text"
                id="usernameInput"
                class="form-control"
                placeholder="游客"
              />
            </div>
          </div>
          <div id="chat-box"></div>
          <div id="chat-input-area">
            <input
              type="text"
              id="chat-input"
              class="form-control form-control-sm"
              placeholder="输入消息..."
            />
            <button id="sendBtn" class="btn btn-primary btn-sm">发送</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.min.js"></script>

    <script>
      const BASE_URL = window.location.origin.replace("https://", "")

      // ===== 视频播放部分 =====
      document.getElementById("playBtn").addEventListener("click", () => {
        if (mpegts.isSupported()) {
          const player = mpegts.createPlayer({
            type: "mpegts",
            url:
              window.location.protocol + "//" + BASE_URL + "/stream/" +
              document.getElementById("roomId").value,
          });
          player.attachMediaElement(document.getElementById("videoElement"));
          player.load();
          player.play();
        } else {
          alert("当前浏览器不支持 MSE 播放 TS");
        }
      });

      // ===== 聊天室部分 =====
      const chatBox = document.getElementById("chat-box");
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("sendBtn");
      const usernameInput = document.getElementById("usernameInput");

      let sentUUIDs = new Set();

      function getUsername() {
        return usernameInput.value.trim() || "游客";
      }

      // 建立 WebSocket 连接
      const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
      const ws = new WebSocket(protocol + BASE_URL + "/danmaku");

      ws.onopen = () => {
        console.log("已连接到聊天服务器");
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (
            sentUUIDs.has(data.uuid) ||
            data.roomId !== document.getElementById("roomId").value
          )
            return; // 忽略自己发的
          appendMessage(data.username, data.msg);
        } catch (e) {
          console.error("解析消息失败:", e);
        }
      };

      ws.onclose = () => {
        appendMessage("系统", "聊天服务器已断开连接");
      };

      function appendMessage(user, msg) {
        const div = document.createElement("div");
        div.innerHTML = `<b>${user}:</b> ${msg}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function generateUUID() {
        if (window.crypto && window.crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
          const r = (Math.random() * 16) | 0;
          const v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      }

      function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        const uuid = generateUUID();
        const data = {
          username: getUsername(),
          msg,
          uuid,
          roomId: document.getElementById("roomId").value,
        };
        ws.send(JSON.stringify(data));
        sentUUIDs.add(uuid);
        appendMessage(getUsername(), msg);
        chatInput.value = "";
      }

      sendBtn.addEventListener("click", sendMessage);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      function autoPlayFromHash() {
        const hash = window.location.hash;
        if (hash && hash.length > 1) {
          const roomId = hash.substring(1);
          document.getElementById("roomId").value = roomId;
          document.getElementById("playBtn").click();
        }
      }

      autoPlayFromHash();

      window.addEventListener("hashchange", autoPlayFromHash);

    </script>
  </body>
</html>
