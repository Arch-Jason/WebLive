package webui_server

import (
	"fmt"
	"net/http"
)

const BASE_URL = "live.sdszintl.org"

func InitHttpRoutes(http_mux *http.ServeMux) {
	http_mux.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		fmt.Println("new WebUI access")
		fmt.Fprint(w, "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <title>在线直播</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <link\n      href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css\"\n      rel=\"stylesheet\"\n    />\n    <style>\n      body {\n        margin: 0;\n        background: #f5f6fa;\n        font-family: \"Segoe UI\", Tahoma, Geneva, Verdana, sans-serif;\n        height: 100vh;\n        display: flex;\n        flex-direction: column;\n      }\n\n      .main-container {\n        display: flex;\n        flex: 1;\n        gap: 1rem;\n        padding: 1rem;\n        flex-wrap: wrap; /* 手机端自动堆叠 */\n        box-sizing: border-box;\n        height: 80vh;\n      }\n\n      .video-wrapper {\n        flex: 3 1 600px; /* 占大部分，最小宽度 600px */\n        display: flex;\n        flex-direction: column;\n        gap: 0.5rem;\n      }\n\n      video {\n        width: 100%;\n        border-radius: 10px;\n        background: #000;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      }\n\n      .chat-wrapper {\n        flex: 1 1 300px; /* 占小部分，最小宽度 300px */\n        display: flex;\n        flex-direction: column;\n        height: 80vh;\n        max-height: 100%;\n      }\n\n      #chat-container {\n        display: flex;\n        flex-direction: column;\n        flex: 1;\n        background: #fff;\n        border-radius: 10px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n        overflow: hidden;\n      }\n\n      #chat-box {\n        flex: 1;\n        overflow-y: auto;\n        padding: 10px;\n        font-size: 14px;\n        background: #fafafa;\n      }\n\n      #chat-input-area {\n        display: flex;\n        padding: 8px;\n        border-top: 1px solid #eee;\n      }\n\n      #chat-input {\n        flex: 1;\n        margin-right: 8px;\n      }\n\n      .room-control {\n        display: flex;\n        align-items: center;\n        gap: 0.5rem;\n      }\n\n      @media (orientation: portrait) {\n        .main-container {\n          flex-direction: row;\n          padding: 0.5rem;\n        }\n        .video-wrapper, .chat-wrapper {\n          flex: 1 1 100%;\n        }\n        #chat-container {\n          height: 50vh;\n          max-height: 50vh;\n        }\n      }\n    </style>\n  </head>\n\n  <body>\n    <div class=\"main-container\">\n      <!-- 视频部分 -->\n      <div class=\"video-wrapper\">\n        <div class=\"room-control\">\n          <input\n            type=\"text\"\n            id=\"roomId\"\n            value=\"stream\"\n            class=\"form-control form-control-sm\"\n            style=\"max-width: 150px\"\n          />\n          <button id=\"playBtn\" class=\"btn btn-success btn-sm\">▶ 播放</button>\n        </div>\n        <video id=\"videoElement\" controls autoplay></video>\n      </div>\n\n      <!-- 聊天部分 -->\n      <div class=\"chat-wrapper\">\n        <div id=\"chat-container\">\n          <div class=\"p-2 border-bottom bg-light\">\n            <div class=\"input-group input-group-sm\">\n              <span class=\"input-group-text\">昵称</span>\n              <input\n                type=\"text\"\n                id=\"usernameInput\"\n                class=\"form-control\"\n                placeholder=\"游客\"\n              />\n            </div>\n          </div>\n          <div id=\"chat-box\"></div>\n          <div id=\"chat-input-area\">\n            <input\n              type=\"text\"\n              id=\"chat-input\"\n              class=\"form-control form-control-sm\"\n              placeholder=\"输入消息...\"\n            />\n            <button id=\"sendBtn\" class=\"btn btn-primary btn-sm\">发送</button>\n          </div>\n        </div>\n      </div>\n    </div>\n    <script src=\"https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.min.js\"></script>\n\n    <script>\n      const BASE_URL = window.location.origin.replace(\"https://\", \"\")\n\n      // ===== 视频播放部分 =====\n      document.getElementById(\"playBtn\").addEventListener(\"click\", () => {\n        if (mpegts.isSupported()) {\n          const player = mpegts.createPlayer({\n            type: \"mpegts\",\n            url:\n              window.location.protocol + \"//\" + BASE_URL + \"/stream/\" +\n              document.getElementById(\"roomId\").value,\n          });\n          player.attachMediaElement(document.getElementById(\"videoElement\"));\n          player.load();\n          player.play();\n        } else {\n          alert(\"当前浏览器不支持 MSE 播放 TS\");\n        }\n      });\n\n      // ===== 聊天室部分 =====\n      const chatBox = document.getElementById(\"chat-box\");\n      const chatInput = document.getElementById(\"chat-input\");\n      const sendBtn = document.getElementById(\"sendBtn\");\n      const usernameInput = document.getElementById(\"usernameInput\");\n\n      let sentUUIDs = new Set();\n\n      function getUsername() {\n        return usernameInput.value.trim() || \"游客\";\n      }\n\n      // 建立 WebSocket 连接\n      const protocol = window.location.protocol === \"https:\" ? \"wss://\" : \"ws://\";\n      const ws = new WebSocket(protocol + BASE_URL + \"/danmaku\");\n\n      ws.onopen = () => {\n        console.log(\"已连接到聊天服务器\");\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          if (\n            sentUUIDs.has(data.uuid) ||\n            data.roomId !== document.getElementById(\"roomId\").value\n          )\n            return; // 忽略自己发的\n          appendMessage(data.username, data.msg);\n        } catch (e) {\n          console.error(\"解析消息失败:\", e);\n        }\n      };\n\n      ws.onclose = () => {\n        appendMessage(\"系统\", \"聊天服务器已断开连接\");\n      };\n\n      function appendMessage(user, msg) {\n        const div = document.createElement(\"div\");\n        div.innerHTML = `<b>${user}:</b> ${msg}`;\n        chatBox.appendChild(div);\n        chatBox.scrollTop = chatBox.scrollHeight;\n      }\n\n      function generateUUID() {\n        if (window.crypto && window.crypto.randomUUID) {\n          return crypto.randomUUID();\n        }\n        return \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g, (c) => {\n          const r = (Math.random() * 16) | 0;\n          const v = c === \"x\" ? r : (r & 0x3) | 0x8;\n          return v.toString(16);\n        });\n      }\n\n      function sendMessage() {\n        const msg = chatInput.value.trim();\n        if (!msg) return;\n        const uuid = generateUUID();\n        const data = {\n          username: getUsername(),\n          msg,\n          uuid,\n          roomId: document.getElementById(\"roomId\").value,\n        };\n        ws.send(JSON.stringify(data));\n        sentUUIDs.add(uuid);\n        appendMessage(getUsername(), msg);\n        chatInput.value = \"\";\n      }\n\n      sendBtn.addEventListener(\"click\", sendMessage);\n      chatInput.addEventListener(\"keydown\", (e) => {\n        if (e.key === \"Enter\") sendMessage();\n      });\n\n      function autoPlayFromHash() {\n        const hash = window.location.hash;\n        if (hash && hash.length > 1) {\n          const roomId = hash.substring(1);\n          document.getElementById(\"roomId\").value = roomId;\n          document.getElementById(\"playBtn\").click();\n        }\n      }\n\n      autoPlayFromHash();\n\n      window.addEventListener(\"hashchange\", autoPlayFromHash);\n\n    </script>\n  </body>\n</html>\n")
	})
}
